<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vSeeBox Heat Live EPL Schedule</title>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface2: #242836;
            --border: #2e3345;
            --text: #e4e6f0;
            --text-muted: #8b8fa3;
            --accent: #6c5ce7;
            --accent-light: #a29bfe;
            --green: #00b894;
            --orange: #fdcb6e;
            --red: #e17055;
            --live-pulse: #ff6b6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1d27 0%, #242836 100%);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .header-title-row { display: flex; align-items: center; gap: 1rem; }
        .header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-light), var(--green));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-subtitle {
            font-size: 0.78rem;
            color: var(--text-muted);
        }
        .header-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text-muted);
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }


        /* Team selector */
        .team-select {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface2);
            color: var(--text);
            cursor: pointer;
            min-width: 240px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238b8fa3' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2rem;
        }
        .team-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.2);
        }

        /* Main content */
        .main { padding: 2rem; max-width: 1200px; margin: 0 auto; }

        /* Section title */
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Schedule table */
        .schedule-table-wrap {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        .schedule-table thead th {
            text-align: left;
            padding: 0.9rem 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            background: var(--surface2);
            position: sticky;
            top: 0;
        }
        .schedule-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }
        .schedule-table tbody tr:last-child { border-bottom: none; }
        .schedule-table tbody tr:hover { background: var(--surface2); }
        .schedule-table td {
            padding: 0.85rem 1rem;
            font-size: 0.88rem;
            vertical-align: top;
        }

        .match-title { font-weight: 600; }
        .match-desc {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-top: 0.2rem;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-live {
            background: rgba(255, 107, 107, 0.15);
            color: var(--live-pulse);
            animation: pulse 2s infinite;
        }
        .badge-channel {
            background: rgba(108, 92, 231, 0.15);
            color: var(--accent-light);
        }
        .badge-playback {
            background: rgba(0, 184, 148, 0.15);
            color: var(--green);
            margin-left: 0.3rem;
        }
        .badge-confirmed {
            background: rgba(0, 184, 148, 0.15);
            color: var(--green);
            font-size: 0.7rem;
        }
        .badge-estimated {
            background: rgba(139, 143, 163, 0.12);
            color: var(--text-muted);
            font-size: 0.7rem;
        }
        .badge-streaming {
            background: rgba(253, 203, 110, 0.15);
            color: var(--orange);
            font-size: 0.7rem;
        }
        .badge-comp {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }
        .badge-comp-pl { background: rgba(55, 0, 130, 0.2); color: #a78bfa; }
        .badge-comp-cl { background: rgba(0, 70, 150, 0.2); color: #60a5fa; }
        .badge-comp-el { background: rgba(230, 126, 34, 0.2); color: #f59e0b; }
        .badge-comp-fac { background: rgba(220, 20, 60, 0.2); color: #f87171; }
        .badge-comp-lc { background: rgba(0, 128, 0, 0.2); color: #4ade80; }
        .comp-filter {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }
        .comp-filter button {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.3rem 0.7rem;
            border-radius: 6px;
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .comp-filter button:hover { border-color: var(--accent-light); color: var(--text); }
        .comp-filter button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .broadcast-legend {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .broadcast-legend span {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .channel-cell {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .channel-number {
            font-weight: 700;
            font-size: 1rem;
            color: var(--accent-light);
        }
        .channel-name {
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }
        .empty-state svg {
            width: 48px; height: 48px;
            margin-bottom: 1rem;
            opacity: 0.4;
        }


        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--text-muted);
        }
        .spinner {
            width: 24px; height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.75rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 1rem; }
            .main { padding: 1rem; }
            .team-select { min-width: 100%; }
            .schedule-table td, .schedule-table th { padding: 0.6rem 0.5rem; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <div class="header-title-row">
            <h1>vSeeBox Heat Live Soccer Schedule</h1>
            <span class="header-badge" id="data-source-badge">Loading...</span>
        </div>
        <div class="header-subtitle" id="header-subtitle">Latest game in schedule: loading...</div>
    </div>
    <div class="header-right">
        <select class="team-select" id="team-select">
            <option value="all">All Teams</option>
        </select>
    </div>
</div>

<div class="main" id="main-content">
    <div class="loading">
        <div class="spinner"></div>
        Loading schedule data...
    </div>
</div>

<div class="footer">
    vSeeBox Heat Live Soccer Schedule &mdash; Channel data from
    <a href="https://www.vseebox.net/pages/channel-list" style="color:var(--accent-light)">vseebox.net</a>
</div>

<script>
// ─── State ───
let allTeams = [];
let allSchedule = [];
let allChannels = [];
let metadata = {};

// ─── Data Loading ───
async function loadData() {
    try {
        const [teamsRes, scheduleRes, channelsRes, metaRes] = await Promise.all([
            fetch('data/teams.json'),
            fetch('data/schedule.json'),
            fetch('data/channels.json'),
            fetch('data/metadata.json'),
        ]);
        allTeams = await teamsRes.json();
        allSchedule = await scheduleRes.json();
        allChannels = await channelsRes.json();
        metadata = await metaRes.json();

        populateTeamDropdown();
        updateHeader();
        render();
    } catch (err) {
        document.getElementById('main-content').innerHTML = `
            <div class="empty-state">
                <p style="font-size:1.1rem;margin-bottom:0.5rem;">Could not load data</p>
                <p>Make sure <code>data/</code> folder contains the JSON files.<br>
                Run <code>python export_data.py --sample</code> to generate sample data.</p>
            </div>`;
    }
}

function populateTeamDropdown() {
    const sel = document.getElementById('team-select');
    allTeams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.shortName || t.name;
        opt.textContent = `${t.shortName || t.name} (${t.tla || t.abbreviation || ''})`;
        sel.appendChild(opt);
    });
    sel.addEventListener('change', render);
}

function updateHeader() {
    const badge = document.getElementById('data-source-badge');
    badge.textContent = metadata.isSampleData ? 'Sample Data' : '2025-26 Season';

    // Compute latest game across ALL schedule data (unaffected by filters)
    const subtitle = document.getElementById('header-subtitle');
    if (allSchedule.length > 0) {
        const sorted = [...allSchedule].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        const latest = new Date(sorted[0].startTime);
        const dateStr = latest.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        subtitle.textContent = `Latest game in schedule: ${dateStr}`;
    } else {
        subtitle.textContent = 'Latest game in schedule: No data';
    }
}

// ─── Filtering ───
function getFilteredSchedule() {
    const team = document.getElementById('team-select').value;
    let games = [...allSchedule].sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

    if (team !== 'all') {
        const teamLower = team.toLowerCase();
        const teamObj = allTeams.find(t => (t.shortName || t.name) === team);
        const tla = teamObj ? (teamObj.tla || teamObj.abbreviation || '').toLowerCase() : '';
        games = games.filter(g => {
            const home = (g.homeTeam || '').toLowerCase();
            const away = (g.awayTeam || '').toLowerCase();
            const homeTla = (g.homeTeamTla || '').toLowerCase();
            const awayTla = (g.awayTeamTla || '').toLowerCase();
            const t = (g.title || '').toLowerCase();
            const d = (g.description || '').toLowerCase();
            return home === teamLower || away === teamLower ||
                   (tla && (homeTla === tla || awayTla === tla)) ||
                   t.includes(teamLower) || d.includes(teamLower);
        });
    }
    return games;
}

// ─── Render ───
function render() {
    const games = getFilteredSchedule();
    const team = document.getElementById('team-select').value;

    const now = new Date();
    const upcoming = games.filter(g => new Date(g.startTime) >= now);

    const main = document.getElementById('main-content');
    main.innerHTML = '';

    // Competition filter
    const compCodes = [...new Set(games.map(g => g.competitionCode || 'PL'))];
    const compNames = { PL: 'Premier League', CL: 'Champions League', EL: 'Europa League', FAC: 'FA Cup', LC: 'EFL Cup' };

    let compFilterHtml = '';
    if (compCodes.length > 1) {
        compFilterHtml = `<div class="comp-filter" id="comp-filter">
            <button class="active" data-comp="all">All Competitions</button>
            ${compCodes.map(c => `<button data-comp="${c}">${compNames[c] || c}</button>`).join('')}
        </div>`;
    }

    // Schedule table
    main.insertAdjacentHTML('beforeend', `
        <div class="section-title">Upcoming Schedule</div>
        ${compFilterHtml}
        <div class="broadcast-legend">
            <span><span class="badge badge-confirmed">✓ Confirmed</span> Verified US TV channel</span>
            <span><span class="badge badge-streaming">▶ Streaming</span> Peacock only (no TV channel)</span>
            <span><span class="badge badge-estimated">TBD</span> Not yet announced</span>
        </div>`);

    // Wire up competition filter buttons
    const compFilter = document.getElementById('comp-filter');
    if (compFilter) {
        compFilter.addEventListener('click', e => {
            if (e.target.tagName !== 'BUTTON') return;
            compFilter.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            const comp = e.target.dataset.comp;
            const filtered = comp === 'all' ? upcoming : upcoming.filter(g => (g.competitionCode || 'PL') === comp);
            const tableWrap = main.querySelector('.schedule-table-wrap');
            if (tableWrap) tableWrap.outerHTML = buildScheduleTable(filtered);
        });
    }

    if (upcoming.length === 0) {
        main.insertAdjacentHTML('beforeend', `
            <div class="empty-state">
                <p style="font-size:1.1rem;margin-bottom:0.5rem;">No upcoming games found</p>
                <p>${team === 'all' ? 'No EPL games in the current data window.' : `No upcoming games for ${team}.`}<br>
                Try selecting a different team or refreshing the data.</p>
            </div>`);
    } else {
        main.insertAdjacentHTML('beforeend', buildScheduleTable(upcoming));
    }
}

function buildScheduleTable(games) {
    let rows = '';
    let currentDate = '';

    games.forEach(g => {
        const start = new Date(g.startTime);
        const dateStr = start.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

        if (dateStr !== currentDate) {
            currentDate = dateStr;
            rows += `<tr><td colspan="4" style="padding:0.6rem 1rem;font-size:0.78rem;font-weight:600;color:var(--accent-light);background:var(--surface2);border-bottom:1px solid var(--border);">${dateStr}</td></tr>`;
        }

        const timeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZoneName: 'short' });
        const liveBadge = g.isLive ? '<span class="badge badge-live">LIVE</span> ' : '';
        const statusBadge = g.status === 'FINISHED' ? '<span class="badge" style="background:rgba(0,184,148,0.15);color:var(--green);">FT</span> ' : '';
        const compCode = g.competitionCode || 'PL';
        const compClass = `badge-comp-${compCode.toLowerCase()}`;
        const compLabel = { PL: 'PL', CL: 'UCL', EL: 'UEL', FAC: 'FA', LC: 'LC' }[compCode] || compCode;
        const compBadge = compCode !== 'PL' ? `<span class="badge badge-comp ${compClass}">${compLabel}</span> ` : '';
        const matchdayStr = g.matchday ? `MD ${g.matchday}` : '';
        const channels = g.channels || (g.channel ? [g.channel] : []);
        const channelsHtml = channels.length > 0
            ? channels.map((ch, i) => {
                const dvr = ch.hasPlayback ? ' <span class="badge badge-playback">DVR</span>' : '';
                if (i === 0) {
                    return `<div style="margin-bottom:0.3rem;"><span class="channel-number" style="font-size:0.85rem;">Ch. ${ch.number}</span> <span class="channel-name">${escapeHtml(ch.name)}${dvr}</span></div>`;
                }
                return `<div style="margin-bottom:0.15rem;opacity:0.45;font-size:0.75rem;"><span style="color:var(--accent-light);">Ch. ${ch.number}</span> <span class="channel-name">${escapeHtml(ch.name)}${dvr}</span></div>`;
            }).join('')
            : '<span style="color:var(--text-muted)">—</span>';

        rows += `
            <tr>
                <td style="white-space:nowrap;">
                    <div style="font-weight:600;">${timeStr}</div>
                    <div style="font-size:0.72rem;color:var(--text-muted);">${matchdayStr}</div>
                </td>
                <td>
                    <div class="match-title">${compBadge}${liveBadge}${statusBadge}${escapeHtml(g.title)}</div>
                    <div class="match-desc">${escapeHtml(g.description)}</div>
                </td>
                <td>
                    <div class="channel-cell">${channelsHtml}</div>
                </td>
                <td>
                    ${g.broadcastConfirmed
                        ? `<span class="badge badge-confirmed">✓ ${escapeHtml(g.broadcaster)}</span>`
                        : g.broadcaster === 'Not yet announced'
                            ? `<span class="badge badge-estimated">TBD</span>`
                            : `<span class="badge badge-streaming">▶ ${escapeHtml(g.broadcaster)}</span>`
                    }
                </td>
            </tr>`;
    });

    return `<div class="schedule-table-wrap"><table class="schedule-table">
        <thead><tr>
            <th>Time</th><th>Match</th><th>Possible Channels</th><th>Broadcaster</th>
        </tr></thead>
        <tbody>${rows}</tbody>
    </table></div>`;
}

// ─── Helpers ───
function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
}

// ─── Init ───
loadData();
</script>
</body>
</html>
